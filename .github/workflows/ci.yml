name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install heidi-cli
        run: |
          python -m pip install -e '.[dev]'
      - name: Run tests
        run: |
          pytest -q

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install ruff
        run: |
          pip install ruff
      - name: Run ruff
        run: |
          ruff check src tests

  secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for secrets in code
        run: |
          echo "Checking for secret patterns in codebase..."
          patterns=("ghp_" "github_pat_" "GITHUB_TOKEN=" "GH_TOKEN=" "COPILOT_TOKEN=")
          found=false
          for pattern in "${patterns[@]}"; do
            if grep -r "$pattern" --include="*.py" --include="*.yml" --include="*.yaml" --include="*.json" . 2>/dev/null | grep -v "REDACTED" | grep -v "test_" | grep -v "\.git" > /dev/null; then
              echo "Warning: Potential secret pattern found: $pattern"
              found=true
            fi
          done
          if [ "$found" = true ]; then
            echo "Please review any potential secrets above"
          fi

  safety:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check .heidi/ not tracked
        run: |
          echo "Checking that .heidi/ is not tracked..."
          if git ls-files | grep -E "^\.heidi/" > /dev/null; then
            echo "ERROR: .heidi/ directory is tracked in git!"
            git ls-files | grep -E "^\.heidi/"
            exit 1
          fi
          echo "OK: .heidi/ not tracked"
      - name: Check secrets files not tracked
        run: |
          echo "Checking that secrets files are not tracked..."
          if git ls-files | grep -E "(^|/)(secrets|config)\.json$" | grep -v "\.test" > /dev/null; then
            echo "ERROR: Secrets files are tracked in git!"
            git ls-files | grep -E "(^|/)(secrets|config)\.json$"
            exit 1
          fi
          echo "OK: No secrets files tracked"
      - name: Check forbidden paths exist locally
        run: |
          echo "Checking for forbidden paths in working tree..."
          # Note: These paths may exist locally but should NOT be tracked in git
          # The actual check is done above with git ls-files
          FORBIDDEN=".venv venv __pycache__ .pytest_cache .ruff_cache .mypy_cache"
          for path in $FORBIDDEN; do
            if [ -e "$path" ]; then
              echo "Warning: $path exists locally (should be in .gitignore)"
            fi
          done
          echo "OK: Forbidden paths are not tracked in git"

  clean-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run package script
        run: |
          # Use tar directly instead of rsync
          VERSION=$(git rev-parse --short HEAD)
          NAME="heidi-cli-${VERSION}"
          mkdir -p "/tmp/${NAME}"
          cp -r . "/tmp/${NAME}/" 2>/dev/null || true
          cd /tmp
          tar -czf "${PWD}/${NAME}.tar.gz" "${NAME}"
          mv "${NAME}.tar.gz" "$GITHUB_WORKSPACE/"
      - name: Verify packages
        run: |
          ls -la heidi-cli-*.tar.gz || true

  acceptance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install heidi-cli
        run: |
          python -m pip install -e '.[dev]'
          python -m pip install httpx
      - name: Check heidi CLI
        run: |
          HEIDI_NO_WIZARD=1 heidi --help
      - name: Initialize heidi
        run: |
          HEIDI_NO_WIZARD=1 heidi init --force
      - name: Check auth status
        run: |
          HEIDI_NO_WIZARD=1 output=$(heidi auth status 2>&1 || true)
          echo "$output"
          if echo "$output" | grep -E "(ghp_|github_pat_|GITHUB_TOKEN=|GH_TOKEN=)" > /dev/null; then
            echo "ERROR: Token printed in auth status!"
            exit 1
          fi
          echo "OK: No token printed"
      - name: Run doctor
        run: |
          HEIDI_NO_WIZARD=1 heidi doctor

  installer-no-cwd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install heidi-cli
        run: |
          python -m pip install -e '.[dev]'
      - name: Test installer in temp dir
        run: |
          # Create a temp directory
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          
          echo "=== Running from temp dir: $TEMP_DIR ==="
          
          # Check if heidi is installed
          which heidi || echo "heidi not in PATH"
          
          # Try running heidi init
          echo "=== Running heidi init ==="
          set +e
          HEIDI_NO_WIZARD=1 heidi init
          EXIT_CODE=$?
          set -e
          echo "Exit code: $EXIT_CODE"
          
          # List all files including hidden
          echo "Files in CWD:"
          ls -la
          
          # Check for .heidi
          echo "Checking for .heidi..."
          if [ -d ".heidi" ]; then
            echo "FOUND: .heidi exists in CWD"
            ls -la .heidi
          else
            echo "OK: No .heidi in CWD"
          fi
          echo "Checking global config:"
          ls -la "$HOME/.config/heidi" || echo "Global config not found"
