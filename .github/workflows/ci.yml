name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install heidi-cli
        run: |
          python -m pip install -e '.[dev]'
      - name: Run tests
        run: |
          pytest -q

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install ruff
        run: |
          pip install ruff
      - name: Run ruff
        run: |
          ruff check heidi_cli/src client.py sdk.py

  secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for secrets in code
        run: |
          echo "Checking for secret patterns in codebase..."
          patterns=("ghp_" "github_pat_" "GITHUB_TOKEN=" "GH_TOKEN=" "COPILOT_TOKEN=")
          found=false
          for pattern in "${patterns[@]}"; do
            if grep -r "$pattern" --include="*.py" --include="*.yml" --include="*.yaml" --include="*.json" . 2>/dev/null | grep -v "REDACTED" | grep -v "test_" | grep -v "\.git" > /dev/null; then
              echo "Warning: Potential secret pattern found: $pattern"
              found=true
            fi
          done
          if [ "$found" = true ]; then
            echo "Please review any potential secrets above"
          fi

  safety:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check .heidi/ not tracked
        run: |
          echo "Checking that .heidi/ is not tracked..."
          if git ls-files | grep -E "^\.heidi/" > /dev/null; then
            echo "ERROR: .heidi/ directory is tracked in git!"
            git ls-files | grep -E "^\.heidi/"
            exit 1
          fi
          echo "OK: .heidi/ not tracked"
      - name: Check secrets files not tracked
        run: |
          echo "Checking that secrets files are not tracked..."
          if git ls-files | grep -E "(^|/)(secrets|config)\.json$" | grep -v "\.test" > /dev/null; then
            echo "ERROR: Secrets files are tracked in git!"
            git ls-files | grep -E "(^|/)(secrets|config)\.json$"
            exit 1
          fi
          echo "OK: No secrets files tracked"
      - name: Check forbidden paths exist locally
        run: |
          echo "Checking for forbidden paths in working tree..."
          # Note: These paths may exist locally but should NOT be tracked in git
          # The actual check is done above with git ls-files
          FORBIDDEN=".venv venv __pycache__ .pytest_cache .ruff_cache .mypy_cache"
          for path in $FORBIDDEN; do
            if [ -e "$path" ]; then
              echo "Warning: $path exists locally (should be in .gitignore)"
            fi
          done
          echo "OK: Forbidden paths are not tracked in git"

  clean-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run package script
        run: |
          # Use tar directly instead of rsync
          VERSION=$(git rev-parse --short HEAD)
          NAME="heidi-cli-${VERSION}"
          mkdir -p "/tmp/${NAME}"
          cp -r . "/tmp/${NAME}/" 2>/dev/null || true
          cd /tmp
          tar -czf "${PWD}/${NAME}.tar.gz" "${NAME}"
          mv "${NAME}.tar.gz" "$GITHUB_WORKSPACE/"
      - name: Verify packages
        run: |
          ls -la heidi-cli-*.tar.gz || true

  acceptance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install heidi-cli
        run: |
          python -m pip install -e '.[dev]'
          python -m pip install httpx
      - name: Check heidi CLI
        run: |
          HEIDI_NO_WIZARD=1 heidi --help
      - name: Initialize heidi
        run: |
          HEIDI_NO_WIZARD=1 heidi init --force
      - name: Check auth status
        run: |
          HEIDI_NO_WIZARD=1 output=$(heidi auth status 2>&1 || true)
          echo "$output"
          if echo "$output" | grep -E "(ghp_|github_pat_|GITHUB_TOKEN=|GH_TOKEN=)" > /dev/null; then
            echo "ERROR: Token printed in auth status!"
            exit 1
          fi
          echo "OK: No token printed"
      - name: Run doctor
        run: |
          HEIDI_NO_WIZARD=1 heidi doctor

  installer-no-cwd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Test installer in temp dir
        run: |
          # Create a temp directory and run installer from there
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          
          echo "Running from: $(pwd)"
          echo "Testing: curl ... | bash should NOT create ./.heidi"
          
          # Run installer logic (simulated - just test heidi commands)
          python -m pip install -e '/home/runner/work/heidi-cli/heidi-cli/[dev]' -q 2>/dev/null || true
          
          # Initialize heidi to create global config
          HEIDI_NO_WIZARD=1 heidi init
          
          # Verify NO .heidi in current directory
          if [ -d ".heidi" ]; then
            echo "ERROR: .heidi created in CWD: $(pwd)/.heidi"
            ls -la .heidi
            exit 1
          fi
          
          # Verify global config was created
          if [ ! -d "$HOME/.config/heidi" ]; then
            echo "ERROR: Global config not created at $HOME/.config/heidi"
            exit 1
          fi
          
          echo "OK: No .heidi in CWD, global config exists at $HOME/.config/heidi"
          
          # Test heidi paths shows absolute global paths
          OUTPUT=$(heidi paths 2>&1 || true)
          echo "$OUTPUT"
          
          if ! echo "$OUTPUT" | grep -q "$HOME/.config/heidi"; then
            echo "ERROR: heidi paths should show absolute global path"
            exit 1
          fi
          
          if ! echo "$OUTPUT" | grep -q "Project Root"; then
            echo "ERROR: heidi paths should show Project Root"
            exit 1
          fi
          
          if ! echo "$OUTPUT" | grep -q "Tasks"; then
            echo "ERROR: heidi paths should show Tasks path"
            exit 1
          fi
          
          echo "OK: All installer checks passed"
