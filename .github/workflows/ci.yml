name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install heidi-cli
        run: |
          python -m pip install -e '.[dev]'
      - name: Run tests
        run: |
          pytest -q

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install ruff
        run: |
          pip install ruff
      - name: Run ruff
        run: |
          ruff check heidi_cli/src client.py sdk.py

  secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for secrets in code
        run: |
          echo "Checking for secret patterns in codebase..."
          patterns=("ghp_" "github_pat_" "GITHUB_TOKEN=" "GH_TOKEN=" "COPILOT_TOKEN=")
          found=false
          for pattern in "${patterns[@]}"; do
            if grep -r "$pattern" --include="*.py" --include="*.yml" --include="*.yaml" --include="*.json" . 2>/dev/null | grep -v "REDACTED" | grep -v "test_" | grep -v "\.git" > /dev/null; then
              echo "Warning: Potential secret pattern found: $pattern"
              found=true
            fi
          done
          if [ "$found" = true ]; then
            echo "Please review any potential secrets above"
          fi

  safety:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check .heidi/ not tracked
        run: |
          echo "Checking that .heidi/ is not tracked..."
          if git ls-files | grep -E "^\.heidi/" > /dev/null; then
            echo "ERROR: .heidi/ directory is tracked in git!"
            git ls-files | grep -E "^\.heidi/"
            exit 1
          fi
          echo "OK: .heidi/ not tracked"
      - name: Check secrets files not tracked
        run: |
          echo "Checking that secrets files are not tracked..."
          if git ls-files | grep -E "(secrets\.json|config\.json)$" | grep -v "\.test" > /dev/null; then
            echo "ERROR: Secrets files are tracked in git!"
            git ls-files | grep -E "(secrets\.json|config\.json)$"
            exit 1
          fi
          echo "OK: No secrets files tracked"

  acceptance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install heidi-cli
        run: |
          python -m pip install -e '.[dev]'
      - name: Check heidi CLI
        run: |
          heidi --help
      - name: Initialize heidi
        run: |
          heidi init --force
      - name: Check auth status
        run: |
          output=$(heidi auth status 2>&1 || true)
          echo "$output"
          if echo "$output" | grep -E "(ghp_|github_pat_|GITHUB_TOKEN=|GH_TOKEN=)" > /dev/null; then
            echo "ERROR: Token printed in auth status!"
            exit 1
          fi
          echo "OK: No token printed"
      - name: Run doctor
        run: |
          heidi doctor
